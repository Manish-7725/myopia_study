<!DOCTYPE html>
<html lang="en">

<head>
    <!-- ================================
             Meta
        ================================ -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>User Dashboard • Myopia Study</title>

    <!-- ================================
             Icons & Fonts
        ================================ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
        /* =========================================================
   THEME VARIABLES
========================================================= */
        :root {
            --blue: #0A6EF2;
            --blue-light: #E9F4FF;
            --border: #DFE7EE;

            --sidebar-width: 240px;
            --sidebar-collapsed: 70px;
        }

        /* =========================================================
   BASE STYLES
========================================================= */
        body {
            background: #F5F7FA;
            font-family: "Inter", sans-serif;
        }

        /* =========================================================
   SIDEBAR
========================================================= */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;

            background: #fff;
            border-right: 1px solid var(--border);

            overflow-x: hidden;
            z-index: 1000;
            transition: width 0.3s ease;
        }

        #sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        /* Sidebar text */
        #sidebar .sidebar-text {
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }

        #sidebar.collapsed .sidebar-text {
            opacity: 0;
            visibility: hidden;
        }

        /* Sidebar items */
        #sidebar .list-group-item {
            border: none;
            padding: 14px 18px;
            cursor: pointer;
            font-weight: 500;
        }

        #sidebar .list-group-item i {
            width: 24px;
            font-size: 18px;
            text-align: center;
        }

        #sidebar .list-group-item.active {
            background: var(--blue-light);
            border-left: 4px solid var(--blue);
            color: var(--blue);
            font-weight: 600;
        }

        /* =========================================================
   CONTENT LAYOUT
========================================================= */
        #content {
            margin-left: var(--sidebar-width);
            padding: 26px;
            transition: margin-left 0.3s ease;
        }

        #content.expanded {
            margin-left: var(--sidebar-collapsed);
        }

        /* =========================================================
   SECTION HEADERS
========================================================= */
        .section-title {
            background: var(--blue-light);
            color: var(--blue);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* =========================================================
   CARDS
========================================================= */
        .card {
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
        }

        /* =========================================================
   TABLES
========================================================= */
        table thead {
            background: var(--blue-light);
        }

        table tbody tr:hover {
            background: #F7FBFF;
        }

        /* =========================================================
   SPA SECTIONS
========================================================= */
        .spa-section {
            display: none;
            animation: fadeIn 0.25s ease;
        }

        .spa-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* =========================================================
   REVIEW OVERLAY (FORM REVIEW)
========================================================= */
        .review-overlay {
            position: fixed;
            inset: 0;

            background: rgba(0, 0, 0, 0.35);
            display: none;

            align-items: center;
            justify-content: center;

            z-index: 2000;
        }

        .review-overlay.show {
            display: flex;
        }

        .review-box {
            width: min(900px, 92vw);
            max-height: 80vh;
            padding: 16px;

            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;

            overflow: auto;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        /* =========================================================
   SUCCESS STATE
========================================================= */
        .success-card {
            text-align: center;
            padding: 50px 20px;
            animation: fadeIn 0.5s ease;
        }

        .success-icon {
            width: 80px;
            height: 80px;

            display: inline-flex;
            align-items: center;
            justify-content: center;

            background: #d1e7dd;
            color: #198754;

            border-radius: 50%;
            font-size: 40px;
            margin-bottom: 20px;
        }


        /* =========================================================
   FORM VALIDATION
========================================================= */
        .error-msg {
            font-size: 12px;
            color: #d9534f;
            margin-top: 3px;
        }

        input.is-invalid,
        select.is-invalid,
        textarea.is-invalid {
            border-color: #d9534f !important;
        }

        .row>* {
            flex-shrink: 0;
            width: 100%;
            max-width: 100%;
            padding-right: calc(var(--bs-gutter-x) * .5);
            padding-left: calc(var(--bs-gutter-x) * .5);
            margin-top: var(--bs-gutter-y);
        }
    </style>
</head>



<body>

    <!-- =====================================================
         SIDEBAR
    ===================================================== -->
    <div class="container-fluid">
        <aside id="sidebar">

            <!-- App Title -->
            <div class="p-3 fw-bold text-center" style="color:var(--blue); font-size:20px;">
                <span class="sidebar-text">Myopia Study</span>
            </div>

            <!-- Navigation -->
            <div class="list-group list-group-flush">

                <!-- Dashboard -->
                <a class="list-group-item active" onclick="showSection('dashboard', this)">
                    <i class="bi bi-grid"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>

                <!-- Students -->
                <a class="list-group-item" onclick="showSection('patients', this)">
                    <i class="bi bi-people"></i>
                    <span class="sidebar-text">Students</span>
                </a>

                <!-- New Entry -->
                <a class="list-group-item" onclick="showSection('forms', this)">
                    <i class="bi bi-journal-plus"></i>
                    <span class="sidebar-text">New Entry<span>
                </a>

                <!-- Follow-Ups -->
                <a class="list-group-item" onclick="showSection('followups', this)">
                    <i class="bi bi-calendar-check"></i>
                    <span class="sidebar-text">Follow-Ups</span>
                </a>

                <!-- Logout -->
                <a class="list-group-item text-danger" onclick="submitLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="sidebar-text">Logout</span>
                </a>

            </div>
        </aside>
    </div>

    <!-- =====================================================
     TOP NAVBAR
===================================================== -->
    <nav class="navbar bg-white border-bottom sticky-top px-3" style="z-index:1020;">

        <!-- Sidebar Toggle -->
        <button class="btn btn-light" onclick="toggleSidebar()">
            <i class="fa fa-list white"></i>
        </button>

        <!-- Profile Dropdown -->
        <div class="ms-auto dropdown">

            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark"
                id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">

                <span id="welcomeUser" class="me-2 text-muted d-none d-md-inline"></span>

                <img src="https://ui-avatars.com/api/user.name" class="rounded-circle border" width="36" height="36">
            </a>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-0" aria-labelledby="profileDropdown"
                style="width:320px;">

                <!-- Header -->
                <div class="bg-primary p-3 rounded-top text-white text-center">
                    <h6 class="mb-0 fw-bold">My Profile</h6>
                </div>

                <!-- Profile Details -->
                <div class="p-4">
                    <div class="d-flex align-items-center gap-3 mb-3">

                        <div class="rounded-circle bg-light text-primary
                                d-flex justify-content-center align-items-center
                                fw-bold border" style="width:60px; height:60px; font-size:24px; flex-shrink:0;">
                        </div>

                        <div style="overflow:hidden;">
                            <h5 class="fw-bold mb-1 text-truncate">
                                {user.name}
                            </h5>

                            <div class="text-muted small text-truncate">
                                <i class="bi bi-envelope me-1"></i>{user.email}
                            </div>

                            <div class="text-muted small">
                                <i class="bi bi-telephone me-1"></i>{user.phone}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-outline-primary btn-sm" onclick="openEditProfile()">
                            <i class="bi bi-pencil-square me-1"></i>
                            Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Footer -->
                <div class="border-top p-2 bg-light rounded-bottom text-center">
                    <a href="#" class="text-danger text-decoration-none small fw-bold" onclick="submitLogout()">
                        Logout
                    </a>
                </div>

            </div>
        </div>
    </nav>

    <!-- =====================================================
         MAIN CONTENT
======================================================= -->
    <div id="content">

        <!-- =====================================================
     DASHBOARD OVERVIEW
===================================================== -->
        <section id="dashboard" class="spa-section active">

            <!-- Section Header -->
            <div class="section-title">
                Clinician's Dashboard
            </div>

            <!-- =====================
     DASHBOARD METRICS
===================== -->
            <div class="row g-3">

                <!-- Total Patients -->
                <div class="col-md-4 col-lg-3">
                    <div class="card p-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-people-fill fs-2 text-primary"></i>
                            </div>
                            <div>
                                <small class="text-muted">Total Students</small>
                                <h3 class="fw-bold" id="totalStudents">--</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Follow-ups Due -->
                <div class="col-md-4 col-lg-3">
                    <div class="card p-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-calendar-check-fill fs-2 text-warning"></i>
                            </div>
                            <div>
                                <small class="text-muted">Follow-ups Due</small>
                                <h3 class="fw-bold" id="followupsDue">--</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Follow-ups -->
                <div class="col-md-4 col-lg-3">
                    <div class="card p-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-calendar-event-fill fs-2 text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted">Total Follow-ups</small>
                                <h3 class="fw-bold" id="totalFollowups">--</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Entries -->
                <div class="col-md-4 col-lg-3">
                    <div class="card p-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-journal-check fs-2 text-success"></i>
                            </div>
                            <div>
                                <small class="text-muted">Today's Entries</small>
                                <h3 class="fw-bold" id="todayEntries">--</h3>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- =====================
                 QUICK ACTIONS
            ===================== -->
            <div class="mt-4">
                <h5 class="fw-bold mb-3">Quick Actions</h5>
                <button class="btn btn-outline-primary"
                    onclick="showSection('patients', document.querySelector('a[onclick*=patients]'))">
                    <i class="bi bi-person-plus me-2"></i>
                    Register New Student
                </button>
            </div>

            <!-- =====================
                 RECENT ACTIVITY (LAST 20 ENTRIES)
            ===================== -->
            <div class="card mt-4">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span>Recent Student Activity (Last 20 Entries)</span>
                    <a href="#" class="small text-decoration-none"
                        onclick="showSection('patients', document.querySelector('a[onclick*=patients]'))">
                        View all
                    </a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Student Name</th>
                                <th>Activity</th>
                                <th>Date</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityList">
                            <tr>
                                <td class="ps-4">Sunita Devi</td>
                                <td>New Clinical Entry</td>
                                <td>2026-01-01</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border">View Entry</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">Amit Singh</td>
                                <td>Registered</td>
                                <td>2025-12-28</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border">View Student</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">Priya Sharma</td>
                                <td>Follow-up</td>
                                <td>2025-12-27</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border">View Details</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </section>

        <!-- =====================================================
     PATIENTS SECTION
===================================================== -->
        <section id="patients" class="spa-section">
            <div class="section-title">
                Student Management
            </div>
            <div class="card mb-4">
                <div class="card-body">
                    <form onsubmit="event.preventDefault(); filterPatients();"
                        class="d-flex justify-content-between align-items-center">

                        <!-- Search -->
                        <div class="input-group" style="max-width:320px;">
                            <span class="input-group-text bg-light border-end-0 text-muted">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="patientSearchInput" class="form-control border-start-0 ps-1"
                                placeholder="Search by Student Name, ID...">
                        </div>

                        <!-- Filter -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-funnel"></i>&nbsp; Filter
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:320px;">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label for="dateFromFilter" class="form-label small fw-bold">Date From</label>
                                        <input type="date" id="dateFromFilter" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dateToFilter" class="form-label small fw-bold">Date To</label>
                                        <input type="date" id="dateToFilter" class="form-control form-control-sm">
                                    </div>
                                </div>
                                <div class="mb-2 mt-2">
                                    <label for="dateFilter" class="form-label small fw-bold">Single Date</label>
                                    <input type="date" id="dateFilter" class="form-control form-control-sm">
                                </div>
                                <div class="mb-2">
                                    <label for="schoolFilter" class="form-label small fw-bold">School Name</label>
                                    <input type="text" id="schoolFilter" class="form-control form-control-sm">
                                </div>
                                <div class="mb-2">
                                    <label for="genderFilter" class="form-label small fw-bold">Gender</label>
                                    <select id="genderFilter" class="form-select form-select-sm">
                                        <option value="">All</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="ageFilter" class="form-label small fw-bold">Age</label>
                                    <input type="number" id="ageFilter" class="form-control form-control-sm">
                                </div>
                                <div class="d-grid gap-2 pt-2 border-top">
                                    <button class="btn btn-sm btn-primary" type="button"
                                        onclick="applyPatientFilters()">
                                        Apply Filters
                                    </button>
                                    <button class="btn btn-sm btn-light" type="button" onclick="clearPatientFilters()">
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card p-0 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="patientsTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Student ID</th>
                                <th>Student Name</th>
                                <th>School Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Last Visit</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="ps-4 fw-bold text-primary">STU-1088</td>
                                <td>Amit Patel</td>
                                <td>ABC School</td>
                                <td>12</td>
                                <td>Male</td>
                                <td>2025-10-20</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border" onclick="viewStudent('STU-1088')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-primary ms-2"
                                        onclick="newEntryForPatient('STU-1088')">
                                        New Entry
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4 fw-bold text-primary">STU-1092</td>
                                <td>Sara Khan</td>
                                <td>XYZ School</td>
                                <td>14</td>
                                <td>Female</td>
                                <td>2025-10-15</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border" onclick="viewStudent('STU-1092')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-primary ms-2"
                                        onclick="newEntryForPatient('STU-1092')">
                                        New Entry
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="7" class="p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="small text-muted" id="patientPaginationInfo">
                                            Showing 1–50
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-outline-secondary btn-sm" id="patientPrevBtn"
                                                onclick="prevPatientPage()">
                                                <i class="fa fa-chevron-left"></i>&nbsp; Prev
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="patientNextBtn"
                                                onclick="nextPatientPage()">
                                                Next &nbsp;<i class="fa fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <section id="forms" class="spa-section">

            <div id="formsListState">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="section-title mb-0 w-100">New Clinical Entry</div>
                    <button class="btn btn-primary ms-3 text-nowrap" onclick="switchFormState('entry')">
                        <i class="fas fa-plus lg-4 me-2"></i>New Entry
                    </button>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <form onsubmit="event.preventDefault(); filterForms();"
                            class="d-flex justify-content-between align-items-center">

                            <!-- Search -->
                            <div class="input-group" style="max-width:320px;">
                                <span class="input-group-text bg-light border-end-0 text-muted">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" id="searchInput" class="form-control border-start-0 ps-1"
                                    placeholder="Search by Student Name, ID...">
                            </div>

                            <!-- Filter -->
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-funnel"></i>&nbsp; Filter
                                </button>
                                <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:280px;">
                                    <div class="mb-2">
                                        <label for="dateFilter" class="form-label small fw-bold">Filter by
                                            Date</label>
                                        <input type="date" id="dateFilter" class="form-control form-control-sm">
                                    </div>
                                    <div class="mb-2">
                                        <label for="statusFilter" class="form-label small fw-bold">Filter by
                                            Status</label>
                                        <select id="statusFilter" class="form-select form-select-sm">
                                            <option value="">All</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Pending">Pending</option>
                                        </select>
                                    </div>
                                    <div class="d-grid gap-2 pt-2 border-top">
                                        <button class="btn btn-sm btn-primary" type="button"
                                            onclick="applyDateFilter()">
                                            Apply Filters
                                        </button>
                                        <button class="btn btn-sm btn-light" type="button" onclick="clearDateFilter()">
                                            Clear Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card p-0 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="formsTable" data-max-entries="50"
                            data-current-page="1">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-2">Student Id</th>
                                    <th>Student Name</th>
                                    <th>School Name</th>
                                    <th>Date Submitted</th>
                                    <th>Status</th>
                                    <th class="text-end pe-4">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#FM-2045</td>
                                    <td>2024-12-08</td>
                                    <td>Rahul Kumar</td>
                                    <td>ABC School</td>
                                    <td><span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-light border"
                                            onclick="viewSubmittedForm('FM-2045')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#FM-2044</td>
                                    <td>2024-12-07</td>
                                    <td>Priya Singh</td>
                                    <td>XYZ School</td>
                                    <td><span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-light border"
                                            onclick="viewSubmittedForm('FM-2044')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                </tr>

                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6" class="p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="small text-muted" id="paginationInfo">
                                                Showing 1–50 of 128
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-outline-secondary btn-sm" id="prevBtn"
                                                    onclick="prevPage()">
                                                    <i class="fa fa-chevron-left"></i>&nbsp; Prev
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" id="nextBtn"
                                                    onclick="nextPage()">
                                                    Next &nbsp;<i class="fa fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="formsEntryState" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                    <button class="btn btn-outline-secondary me-3" onclick="switchFormState('list')">
                        <i class="fa fa-arrow-left"></i> Back to List
                    </button>
                    <h5 class="fw-bold text-primary m-0" id="formEntryTitle">New Entry</h5>
                </div>

                <div class="card p-3 border-primary border-opacity-25 shadow-sm">
                    <div class="container py-2">
                        <div class="text-center mb-3">
                            <h5 class="fw-bold" style="color: var(--blue);">Questionnaire for Myopia Progression
                                Study
                            </h5>
                            <p class="text-muted small">(School-Going Children, Age 6–18 Years)</p>
                        </div>

                        <form id="myopiaForm" class="needs-validation" novalidate>
                            <div class="accordion" id="myopiaFormAccordion">
                                <!-- Section A: Demographic Information -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingA">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapseA" aria-expanded="true" aria-controls="collapseA">
                                            Section A: Demographic Information
                                        </button>
                                    </h2>
                                    <div id="collapseA" class="accordion-collapse collapse show"
                                        aria-labelledby="headingA" data-bs-parent="#myopiaFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <!-- Form content for Section A -->
                                                <div class="col-md-6"><label class="form-label">1. Name of
                                                        Student</label><input type="text" class="form-control"
                                                        name="name" required></div>
                                                <div class="col-md-6"><label class="form-label">2. School
                                                        Name</label><input type="text" class="form-control"
                                                        name="school_name"></div>
                                                <div class="col-md-3"><label class="form-label">3. Age
                                                        (years)</label><input type="number" class="form-control"
                                                        name="age" min="1" required></div>
                                                <div class="col-md-3"><label class="form-label">4. Gender</label><select
                                                        class="form-select" name="gender" required>
                                                        <option value="">Select</option>
                                                        <option value="Male">Male</option>
                                                        <option value="Female">Female</option>
                                                        <option value="Other">Other</option>
                                                    </select></div>
                                                <div class="col-md-3"><label class="form-label">5. Height
                                                        (cm)</label><input type="number" class="form-control"
                                                        name="height" step="0.1"></div>
                                                <div class="col-md-3"><label class="form-label">6. Weight
                                                        (kg)</label><input type="number" class="form-control"
                                                        name="weight" step="0.1"></div>
                                                <div class="col-md-6"><label class="form-label">7. Parental
                                                        Myopia</label><br><input type="radio" name="parental_myopia"
                                                        value="None"> None <input type="radio" name="parental_myopia"
                                                        value="Father"> Father <input type="radio"
                                                        name="parental_myopia" value="Mother"> Mother <input
                                                        type="radio" name="parental_myopia" value="Both"> Both</div>
                                                <div class="col-md-3"><label class="form-label">8. Number of
                                                        Siblings</label><input type="number" class="form-control"
                                                        name="num_siblings" min="0"></div>
                                                <div class="col-md-3"><label class="form-label">9. Birth
                                                        Order</label><select class="form-select" name="birth_order">
                                                        <option value="">Select</option>
                                                        <option value="First">First</option>
                                                        <option value="Second">Second</option>
                                                        <option value="Third">Third</option>
                                                        <option value="Only">Only Child</option>
                                                    </select></div>
                                                <div class="col-md-3"><label class="form-label">10. Siblings with
                                                        Myopia</label><input type="number" class="form-control"
                                                        name="siblings_myopia" min="0"></div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button type="button" class="btn btn-primary" onclick="saveSection('A')">Save Section A</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section B: Behavioral & Lifestyle Factors -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingB">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseB" aria-expanded="false"
                                            aria-controls="collapseB">
                                            Section B: Behavioral & Lifestyle Factors
                                        </button>
                                    </h2>
                                    <div id="collapseB" class="accordion-collapse collapse" aria-labelledby="headingB"
                                        data-bs-parent="#myopiaFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <!-- Form content for Section B -->
                                                <div class="col-md-6"><label class="form-label">11. Time of Daily
                                                        Outdoor Activity</label><input type="time" class="form-control"
                                                        name="outdoor_time"></div>
                                                <div class="col-md-6"><label class="form-label">12. Duration of Outdoor
                                                        Activity</label><br><input type="radio" name="outdoor_duration"
                                                        value="<1 hr"> &lt;1 hr <input type="radio"
                                                        name="outdoor_duration" value="1-2 hrs"> 1–2 hrs <input
                                                        type="radio" name="outdoor_duration" value="2-4 hrs"> 2–4 hrs
                                                    <input type="radio" name="outdoor_duration" value=">4 hrs"> &gt;4
                                                    hrs
                                                </div>
                                                <div class="col-md-6"><label class="form-label">13. Average Daily Sun
                                                        Exposure</label><br><input type="radio" name="sun_exposure"
                                                        value="<15 min"> &lt;15 min <input type="radio"
                                                        name="sun_exposure" value="15-30 min"> 15–30 min <input
                                                        type="radio" name="sun_exposure" value="30-60 min"> 30–60 min
                                                    <input type="radio" name="sun_exposure" value=">1 hr"> &gt;1 hr
                                                </div>
                                                <div class="col-md-6"><label class="form-label">14. Near Work Hours per
                                                        Day</label><br><input type="radio" name="near_work_hours"
                                                        value="<2 hrs"> &lt;2 hrs <input type="radio"
                                                        name="near_work_hours" value="2-4 hrs"> 2–4 hrs <input
                                                        type="radio" name="near_work_hours" value="4-6 hrs"> 4–6 hrs
                                                    <input type="radio" name="near_work_hours" value=">6 hrs"> &gt;6 hrs
                                                </div>
                                                <div class="col-md-6"><label class="form-label">15. Daily Screen
                                                        Time</label><br><input type="radio" name="screen_time"
                                                        value="<1 hr"> &lt;1 hr <input type="radio" name="screen_time"
                                                        value="1-3 hrs"> 1–3 hrs <input type="radio" name="screen_time"
                                                        value="3-5 hrs"> 3–5 hrs <input type="radio" name="screen_time"
                                                        value=">5 hrs"> &gt;5 hrs</div>
                                                <div class="col-md-6"><label class="form-label">16. Primary Device
                                                        Used</label><br><input type="radio" name="primary_device"
                                                        value="TV"> TV <input type="radio" name="primary_device"
                                                        value="Tablet"> Tablet <input type="radio" name="primary_device"
                                                        value="Mobile"> Mobile <input type="radio" name="primary_device"
                                                        value="Laptop/Desktop"> Laptop/Desktop</div>
                                                <div class="col-md-6"><label class="form-label">17. Reading
                                                        Distance</label><br><input type="radio" name="reading_distance"
                                                        value="<20 cm"> &lt;20 cm <input type="radio"
                                                        name="reading_distance" value="20-30 cm"> 20–30 cm <input
                                                        type="radio" name="reading_distance" value=">30 cm"> &gt;30 cm
                                                </div>
                                                <div class="col-md-6"><label class="form-label">18. Viewing Posture
                                                        Ratio</label><br><input type="radio"
                                                        name="viewing_posture_ratio" value="Low"> Low <input
                                                        type="radio" name="viewing_posture_ratio" value="Optimum">
                                                    Optimum <input type="radio" name="viewing_posture_ratio"
                                                        value="High"> High</div>
                                                <div class="col-md-6"><label class="form-label">19. Dietary
                                                        Habit</label><br><input type="radio" name="dietary_habit"
                                                        value="Balanced"> Balanced <input type="radio"
                                                        name="dietary_habit" value="Junk"> Junk-food dominant <input
                                                        type="radio" name="dietary_habit" value="Vegetarian"> Vegetarian
                                                    <input type="radio" name="dietary_habit" value="NonVegetarian">
                                                    Non-vegetarian <input type="radio" name="dietary_habit"
                                                        value="Other"> Other <input type="text"
                                                        class="form-control mt-2" name="dietary_other"
                                                        placeholder="If other, specify">
                                                </div>
                                                <div class="col-md-6"><label class="form-label">20. Average Sleep
                                                        Duration</label><br><input type="radio" name="sleep_duration"
                                                        value="<6 hrs"> &lt;6 hrs <input type="radio"
                                                        name="sleep_duration" value="6-7 hrs"> 6–7 hrs <input
                                                        type="radio" name="sleep_duration" value="7-8 hrs"> 7–8 hrs
                                                    <input type="radio" name="sleep_duration" value=">8 hrs"> &gt;8 hrs
                                                </div>
                                                <div class="col-md-6"><label class="form-label">21. Usual
                                                        Bedtime</label><br><input type="radio" name="usual_bedtime"
                                                        value="Before 9 PM"> Before 9 PM <input type="radio"
                                                        name="usual_bedtime" value="9-10 PM"> 9–10 PM <input
                                                        type="radio" name="usual_bedtime" value="10-11 PM"> 10–11 PM
                                                    <input type="radio" name="usual_bedtime" value="After 11 PM"> After
                                                    11 PM
                                                </div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button type="button" class="btn btn-primary" onclick="saveSection('B')">Save Section B</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section C: Environmental Factors -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingC">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseC" aria-expanded="false"
                                            aria-controls="collapseC">
                                            Section C: Environmental Factors
                                        </button>
                                    </h2>
                                    <div id="collapseC" class="accordion-collapse collapse" aria-labelledby="headingC"
                                        data-bs-parent="#myopiaFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-4"><label class="form-label">22. School
                                                        Type</label><br><input type="radio" name="school_type"
                                                        value="Urban"> Urban <input type="radio" name="school_type"
                                                        value="Rural"> Rural</div>
                                                <div class="col-md-4"><label class="form-label">23. Classroom
                                                        Strength</label><br><input type="radio"
                                                        name="classroom_strength" value="<30"> &lt;30 <input
                                                        type="radio" name="classroom_strength" value="30-50"> 30–50
                                                    <input type="radio" name="classroom_strength" value=">50"> &gt;50
                                                </div>
                                                <div class="col-md-4"><label class="form-label">24. Seating
                                                        Position</label><br><input type="radio" name="seating_position"
                                                        value="Front"> Front <input type="radio" name="seating_position"
                                                        value="Middle"> Middle <input type="radio"
                                                        name="seating_position" value="Back"> Back</div>
                                                <div class="col-md-6"><label class="form-label">25. Teaching
                                                        Methodology</label><br><input type="radio"
                                                        name="teaching_methodology" value="Digital"> Digital <input
                                                        type="radio" name="teaching_methodology" value="Traditional">
                                                    Traditional</div>
                                                <div class="col-md-6"><label class="form-label">26. Lighting at Study
                                                        Area</label><br><input type="radio" name="lighting" value="Dim">
                                                    Dim <input type="radio" name="lighting" value="Adequate"> Adequate
                                                    <input type="radio" name="lighting" value="Bright"> Bright
                                                </div>
                                                <div class="col-md-6"><label class="form-label">27. Source of
                                                        Sunlight</label><br><input type="radio" name="sunlight_source"
                                                        value="Natural"> Natural <input type="radio"
                                                        name="sunlight_source" value="Artificial"> Artificial <input
                                                        type="radio" name="sunlight_source" value="Both"> Both</div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button type="button" class="btn btn-primary" onclick="saveSection('C')">Save Section C</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section D: Clinical History -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingD">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseD" aria-expanded="false"
                                            aria-controls="collapseD">
                                            Section D: Clinical History
                                        </button>
                                    </h2>
                                    <div id="collapseD" class="accordion-collapse collapse" aria-labelledby="headingD"
                                        data-bs-parent="#myopiaFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6"><label class="form-label">28. Diagnosed with
                                                        Myopia Earlier?</label><br><input type="radio"
                                                        name="diagnosed_earlier" value="true"> Yes <input type="radio"
                                                        name="diagnosed_earlier" value="false"> No</div>
                                                <div class="col-md-6"><label class="form-label">29. Age at Diagnosis
                                                        (years)</label><input type="number" class="form-control"
                                                        name="age_at_diagnosis" min="1"></div>
                                                <div class="col-md-6"><label class="form-label">30. Change in Spectacle
                                                        Power in Last 3 Years?</label><br><input type="radio"
                                                        name="power_changed_last_3yrs" value="true"> Yes <input
                                                        type="radio" name="power_changed_last_3yrs" value="false"> No
                                                </div>
                                                <div class="col-md-6"><label class="form-label">31. Compliance with
                                                        Spectacle Wear</label><br><input type="radio" name="compliance"
                                                        value="Always"> Always <input type="radio" name="compliance"
                                                        value="Sometimes"> Sometimes <input type="radio"
                                                        name="compliance" value="Rarely"> Rarely</div>
                                                <div class="col-md-6"><label class="form-label">32. Previous Spectacle
                                                        Power</label><input type="text" class="form-control mb-2"
                                                        name="previous_re" placeholder="Right Eye"><input type="text"
                                                        class="form-control" name="previous_le" placeholder="Left Eye">
                                                </div>
                                                <div class="col-md-6"><label class="form-label">33. Current Spectacle
                                                        Power</label><input type="text" class="form-control mb-2"
                                                        name="current_re" placeholder="Right Eye"><input type="text"
                                                        class="form-control" name="current_le" placeholder="Left Eye">
                                                </div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button type="button" class="btn btn-primary" onclick="saveSection('D')">Save Section D</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section E: Awareness & Safety -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingE">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseE" aria-expanded="false"
                                            aria-controls="collapseE">
                                            Section E: Awareness & Safety
                                        </button>
                                    </h2>
                                    <div id="collapseE" class="accordion-collapse collapse" aria-labelledby="headingE"
                                        data-bs-parent="#myopiaFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6"><label class="form-label">33. Access to Vision
                                                        Care in Your Area?</label><br><input type="radio"
                                                        name="access_to_vision_care" value="true"> Yes <input
                                                        type="radio" name="access_to_vision_care" value="false"> No
                                                </div>
                                                <div class="col-md-6"><label class="form-label">34. Aware of Eye Strain
                                                        Symptoms?</label><br><input type="radio" name="aware_eye_strain"
                                                        value="true"> Yes <input type="radio" name="aware_eye_strain"
                                                        value="false"> No</div>
                                                <div class="col-md-6"><label class="form-label">35. Follows Preventive
                                                        Measures?</label><br><input type="radio"
                                                        name="follows_preventive_measures" value="Always"> Always <input
                                                        type="radio" name="follows_preventive_measures"
                                                        value="Sometimes"> Sometimes <input type="radio"
                                                        name="follows_preventive_measures" value="Never"> Never</div>
                                                <div class="col-md-6"><label class="form-label">36. Source of
                                                        Awareness</label><br><input type="checkbox"
                                                        name="source_of_awareness" value="School"> School <input
                                                        type="checkbox" name="source_of_awareness" value="Family">
                                                    Family <input type="checkbox" name="source_of_awareness"
                                                        value="Doctor"> Doctor <input type="checkbox"
                                                        name="source_of_awareness" value="Media"> Media <input
                                                        type="checkbox" name="source_of_awareness" value="None"> None
                                                    <input type="text" class="form-control mt-2" name="source_other"
                                                        placeholder="If other, specify">
                                                </div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button type="button" class="btn btn-primary" onclick="saveSection('E')">Save Section E</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section F: Ocular Examination -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingF">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseF" aria-expanded="false"
                                            aria-controls="collapseF">
                                            Section F: Ocular Examination
                                        </button>
                                    </h2>
                                    <div id="collapseF" class="accordion-collapse collapse" aria-labelledby="headingF"
                                        data-bs-parent="#myopiaFormAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6"><label class="form-label">37. Uncorrected Visual
                                                        Acuity</label><input type="text" class="form-control mb-2"
                                                        name="uncorrectedvisual_acuity_right_eye"
                                                        placeholder="Right Eye"><input type="text" class="form-control"
                                                        name="uncorrectedvisual_acuity_left_eye" placeholder="Left Eye">
                                                </div>
                                                <div class="col-md-6"><label class="form-label">38. Best Corrected
                                                        Visual Acuity</label><input type="text"
                                                        class="form-control mb-2"
                                                        name="bestcorrectedvisual_acuity_right_eye"
                                                        placeholder="Right Eye"><input type="text" class="form-control"
                                                        name="bestcorrectedvisual_acuity_left_eye"
                                                        placeholder="Left Eye"></div>
                                                <div class="col-md-6"><label class="form-label">39. Cycloplegic
                                                        Auto-refraction</label><input type="text"
                                                        class="form-control mb-2"
                                                        name="cycloplegic_auto_refraction_right_eye"
                                                        placeholder="Right Eye"><input type="text" class="form-control"
                                                        name="cycloplegic_auto_refraction_left_eye"
                                                        placeholder="Left Eye"></div>
                                                <div class="col-md-6"><label class="form-label">40. Spherical
                                                        Power</label><input type="text" class="form-control mb-2"
                                                        name="spherical_power_right_eye" placeholder="Right Eye"><input
                                                        type="text" class="form-control" name="spherical_power_left_eye"
                                                        placeholder="Left Eye"></div>
                                                <div class="col-md-6"><label class="form-label">41. Axial Length
                                                        (mm)</label><input type="text" class="form-control mb-2"
                                                        name="axial_length_right_eye" placeholder="Right Eye"><input
                                                        type="text" class="form-control" name="axial_length_left_eye"
                                                        placeholder="Left Eye"></div>
                                                <div class="col-md-6"><label class="form-label">42. Corneal
                                                        Curvature</label><input type="text" class="form-control mb-2"
                                                        name="corneal_curvature_right_eye"
                                                        placeholder="Right Eye"><input type="text" class="form-control"
                                                        name="corneal_curvature_left_eye" placeholder="Left Eye"></div>
                                                <div class="col-md-6"><label class="form-label">43. Central Corneal
                                                        Thickness (µm)</label><input type="text"
                                                        class="form-control mb-2"
                                                        name="central_corneal_thickness_right_eye"
                                                        placeholder="Right Eye"><input type="text" class="form-control"
                                                        name="central_corneal_thickness_left_eye"
                                                        placeholder="Left Eye"></div>
                                                <div class="col-md-6"><label class="form-label">44. Anterior Segment
                                                        Findings</label><textarea class="form-control mb-2"
                                                        name="anterior_segment_finding_right_eye" rows="1"
                                                        placeholder="Right Eye"></textarea><textarea
                                                        class="form-control" name="anterior_segment_finding_left_eye"
                                                        rows="1" placeholder="Left Eye"></textarea></div>
                                                <div class="col-md-6"><label class="form-label">45. Amblyopia /
                                                        Strabismus</label><br><input type="radio"
                                                        name="amblyopia_or_strabismus" value="true"> Yes <input
                                                        type="radio" name="amblyopia_or_strabismus" value="false"> No
                                                </div>
                                                <div class="col-md-12"><label class="form-label">46. Fundus Examination
                                                        Findings</label><textarea class="form-control mb-2"
                                                        name="fundus_examination_finding_right_eye" rows="2"
                                                        placeholder="Right Eye"></textarea><textarea
                                                        class="form-control" name="fundus_examination_finding_left_eye"
                                                        rows="2" placeholder="Left Eye"></textarea></div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button type="button" class="btn btn-primary" onclick="saveSection('F')">Save Section F</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="formSubmitBtnContainer" class="d-grid gap-2 mt-4" style="display:none;">
                                    <button class="btn btn-primary btn-lg" type="submit" onclick="submitForm()">
                                        Submit All Data
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="popupInline" class="review-overlay" aria-hidden="true">
                            <div class="review-box">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Review Your Responses</h6>
                                    <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="closeReview()">Close</button>
                                </div>
                                <div id="reviewContent" class="small"></div>
                                <div class="mt-3 d-flex gap-2 justify-content-end">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editForm()"
                                        type="button">Edit</button>
                                    <button class="btn btn-success btn-sm" onclick="finalSubmit()"
                                        type="button">Submit</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="formsSuccessState" style="display: none;">
                <div class="d-flex flex-column align-items-center justify-content-center text-center py-5">
                    <div class="success-icon mb-4">
                        <i class="bi bi-check-lg"></i>
                    </div>
                    <h2 class="fw-bold mb-2">Form Submitted Successfully!</h2>
                    <p class="text-muted">The clinical data has been securely recorded.</p>

                    <div class="card p-4 bg-light border-0 my-4" style="min-width: 300px;">
                        <small class="text-uppercase text-muted fw-bold">Generated Form ID</small>
                        <div class="display-6 fw-bold text-dark mt-1" id="successFormId">#FM-0000</div>
                    </div>

                    <div class="d-flex gap-3">
                        <button class="btn btn-outline-primary px-4" onclick="switchFormState('list')">
                            Go to My Forms
                        </button>
                        <button class="btn btn-primary px-4" onclick="switchFormState('entry')">
                            Submit Another
                        </button>
                    </div>
                </div>
            </div>

        </section>

        <section id="followups" class="spa-section">
            <div class="section-title">Follow-Up Management</div>

            <div class="card">
                <button class="btn btn-primary ms-2" onclick="openNewFollowup()">
                    <i class="bi bi-plus-lg me-1"></i>
                    New Follow-Up
                </button>


                <div class="card-header bg-white p-3">
                    <form onsubmit="event.preventDefault(); searchStudent();"
                        class="d-flex justify-content-between align-items-center">
                        <div class="input-group" style="max-width:320px;">
                            <span class="input-group-text bg-light border-end-0 text-muted">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="followupSearchInput" class="form-control border-start-0 ps-1"
                                placeholder="Search by Student Name, ID...">
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-funnel"></i>&nbsp; Filter Options
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-3">
                                <div class="mb-2">
                                    <label for="followupDateFilter" class="form-label small fw-bold">Filter by Next
                                        Visit</label>
                                    <input type="date" id="followupDateFilter" class="form-control form-control-sm">
                                </div>
                                <div class="mb-2">
                                    <label for="followupStatusFilter" class="form-label small fw-bold">Filter by
                                        Status</label>
                                    <select id="followupStatusFilter" class="form-select form-select-sm">
                                        <option value="">All</option>
                                        <option value="Due">Due</option>
                                        <option value="Overdue">Overdue</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="d-grid gap-2 pt-2 border-top">
                                    <button class="btn btn-sm btn-primary" type="button"
                                        onclick="applyFollowupFilters()">
                                        Apply Filters
                                    </button>
                                    <button class="btn btn-sm btn-light" type="button" onclick="clearFollowupFilters()">
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card-body p-0">

                    <div id="followupEntryCard" class="bg-light border-bottom p-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold text-success m-0">
                                <i class="bi bi-file-medical me-2"></i>New Entry for: <span id="entryName"
                                    class="text-dark"></span> <small class="text-muted ms-2">(<span
                                        id="entryId"></span>)</small>
                            </h6>
                            <button class="btn btn-sm btn-close" onclick="hideFollowupForm()"></button>
                        </div>

                        <form id="newFollowupForm" onsubmit="event.preventDefault(); saveFollowup();">
                            <input type="hidden" name="student" id="followupStudentId">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Last Visit Date</label>
                                    <input type="date" name="last_visit_date" class="form-control form-control-sm"
                                        required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Next Visit Date</label>
                                    <input type="date" name="next_visit_date" class="form-control form-control-sm"
                                        required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Status</label>
                                    <select name="status" class="form-select form-select-sm">
                                        <option>Due</option>
                                        <option>Overdue</option>
                                        <option>Completed</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold">Notes</label>
                                    <textarea name="notes" class="form-control form-control-sm" rows="2"
                                        placeholder="Quick clinical notes..."></textarea>
                                </div>
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-sm btn-success">
                                        Save Entry
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table align-middle table-hover" id="followupsTable">
                            <thead class="table-light text-muted small text-uppercase">
                                <tr>
                                    <th class="ps-4">Student ID</th>
                                    <th>Student Name</th>
                                    <th>School Name</th>
                                    <th>Last Visit Date</th>
                                    <th>Status</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="ps-4 fw-medium">STU-1088</td>
                                    <td class="ps-4 fw-medium">Amit Patel</td>
                                    <td>ABC School</td>
                                    <td>2024-09-20</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-light border"
                                            onclick="viewFollowup('STU-1088')"><i class="bi bi-eye"></i> View</button>
                                        <button class="btn btn-sm btn-outline-primary ms-2"
                                            onclick="populateAndShow('STU-1088', 'Amit Patel')"><i
                                                class="bi bi-plus"></i> Follow-up</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="ps-4 fw-medium">STU-1092</td>
                                    <td class="ps-4 fw-medium">Sara Khan</td>
                                    <td>XYZ School</td>
                                    <td>2024-10-15</td>
                                    <td>
                                        <span class="badge bg-danger">Overdue</span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-light border"
                                            onclick="viewFollowup('STU-1092')"><i class="bi bi-eye"></i> View</button>
                                        <button class="btn btn-sm btn-outline-primary ms-2"
                                            onclick="populateAndShow('STU-1092', 'Sara Khan')"><i
                                                class="bi bi-plus"></i> Follow-up</button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6" class="p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="small text-muted" id="followupPaginationInfo">
                                                Showing 1–2 of 2
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-outline-secondary btn-sm" id="followupPrevBtn"
                                                    onclick="prevFollowupPage()">
                                                    <i class="fa fa-chevron-left"></i>&nbsp; Prev
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" id="followupNextBtn"
                                                    onclick="nextFollowupPage()">
                                                    Next &nbsp;<i class="fa fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>
            </div>
        </section>

    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <form id="logoutForm" method="POST" action="login.html"></form>


    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profileEditForm" onsubmit="event.preventDefault(); saveProfileChanges();">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" value="Dr. John Doe" name="full_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" value="+91 98765 43210" name="phone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control bg-light" value="john.doe@clinic.com" disabled>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- =========================================
     FOLLOW-UP FORM MODAL (C + D + F)
========================================= -->
    <div class="modal fade" id="followupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Header -->
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="followupModalTitle">
                        New Follow-Up Entry
                    </h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Body -->
                <div class="modal-body">
                    <form id="followupForm">

                        <!-- =====================
                         BASIC FOLLOW-UP INFO
                    ====================== -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    Student ID
                                </label>
                                <input type="text" class="form-control" name="fuStudentId" id="fuStudentId" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    Visit Date
                                </label>
                                <input type="date" class="form-control" name="fuVisitDate" id="fuLastVisit" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    Next Visit Date
                                </label>
                                <input type="date" class="form-control" name="fuNextVisit" id="fuNextVisit" required>
                            </div>
                        </div>

                        <!-- =================================================
                         SECTION F : OCULAR EXAMINATION
                    ================================================= -->
                        <div class="card mb-3 section-card">
                            <div class="card-header fw-bold">
                                Section F: Ocular Examination
                            </div>

                            <div class="card-body row g-3">

                                <div class="col-md-6"><label>37. Uncorrected
                                        Visual Acuity</label><br>Right eye<input type="text" name="ucva_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="ucva_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>38. Best Corrected
                                        Visual
                                        Acuity (BCVA):</label><br>Right eye<input type="text" name="bcva_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="bcva_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>39. Cycloplegic
                                        Auto-refraction (Spherical
                                        Equivalent):</label><br>Right eye<input type="text" name="cyclo_se_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="cyclo_se_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>40. Spherical
                                        Power:</label><br>Right eye<input type="text" name="spherical_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="spherical_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>41. Axial Length
                                        (mm):</label><br>Right eye<input type="text" name="axial_length_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="axial_length_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>42. Corneal Curvature
                                        (K
                                        readings):</label><br>Right eye<input type="text" name="keratometry_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="keratometry_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>43. Central Corneal
                                        Thickness (µm):</label><br>Right eye<input type="text" name="cct_re"
                                        class="form-control" placeholder="RE">Left
                                    eye<input type="text" name="cct_le" class="form-control" placeholder="LE">
                                </div>
                                <div class="col-md-6"><label>44. . Anterior segment
                                        findings (Torch light):</label><br>Right
                                    eye<textarea name="anterior_segment_re" class="form-control" rows="1"></textarea>
                                    Left eye<textarea name="anterior_segment_le" class="form-control"
                                        rows="1"></textarea>
                                </div>
                                <div class="col-md-6"><label>45.
                                        Amblyopia/Strabismus</label><input type="radio" name="amblyopia_or_strabismus"
                                        value="true" class="form-check-input"> Yes
                                    <input type="radio" name="amblyopia_or_strabismus" value="false"
                                        class="form-check-input"> No
                                </div>
                                <div class="col-md-12"><label>46. Fundus
                                        Findings</label><br>Right eye<textarea name="fundus_findings_re"
                                        class="form-control" rows="1"></textarea>
                                    Left eye<textarea name="fundus_findings_le" class="form-control"
                                        rows="1"></textarea></div>
                            </div>
                        </div>
                </div>

                </form>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button class="btn btn-info" onclick="reviewFollowup()">
                    Review
                </button>
                <button class="btn btn-primary" id="followupSubmitBtn">
                    Submit
                </button>
            </div>

        </div>
    </div>
    </div>

    <!-- =========================================
     FOLLOW-UP REVIEW OVERLAY
========================================= -->
    <div id="followupReviewOverlay" class="review-overlay" aria-hidden="true">
        <div class="review-box">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Review Follow-Up Data</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary"
                    onclick="closeFollowupReview()">Close</button>
            </div>
            <div id="followupReviewContent" class="small"></div>
            <div class="mt-3 d-flex gap-2 justify-content-end">
                <button class="btn btn-outline-primary btn-sm" onclick="editFollowup()" type="button">Edit</button>
                <button class="btn btn-success btn-sm" id="followupFinalSubmitBtn" type="button">Submit
                    Follow-Up</button>
            </div>
        </div>
    </div>




    <script>
        /* =====================================================
           AUTH & SESSION
        ===================================================== */
        const ACCESS_TOKEN = localStorage.getItem("access");

        function requireAuth() {
            if (!ACCESS_TOKEN) {
                window.location.href = "login.html";
            }
        }
        requireAuth();

        /* =====================================================
           DOM HELPERS
        ===================================================== */
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);

        /* =====================================================
           SPA NAVIGATION
        ===================================================== */
        function toggleSidebar() {
            $("#sidebar").classList.toggle("collapsed");
            $("#content").classList.toggle("expanded");
        }

        function showSection(id, el) {
            $$(".spa-section").forEach(s => s.classList.remove("active"));
            $("#" + id).classList.add("active");

            $$("#sidebar .list-group-item").forEach(i => i.classList.remove("active"));
            el.classList.add("active");
        }

        /* =====================================================
           FORMS STATE MANAGEMENT
        ===================================================== */
        function switchFormState(state) {
            ["formsListState", "formsEntryState", "formsSuccessState"].forEach(id => {
                $("#" + id).style.display = "none";
            });

            const target = {
                list: "formsListState",
                entry: "formsEntryState",
                success: "formsSuccessState"
            }[state];

            if (target) {
                $("#" + target).style.display = "block";
                $("#" + target).scrollIntoView({ behavior: "smooth" });
            }
        }

        function toggleFormInputs(disabled) {
            $$("#myopiaForm input, #myopiaForm select, #myopiaForm textarea")
                .forEach(el => el.disabled = disabled);
        }

        function saveSection(sectionId) {
            let sectionData;
            switch (sectionId) {
                case 'A':
                    sectionData = collectSectionA();
                    break;
                case 'B':
                    sectionData = collectSectionB();
                    break;
                case 'C':
                    sectionData = collectSectionC();
                    break;
                case 'D':
                    sectionData = collectSectionD();
                    break;
                case 'E':
                    sectionData = collectSectionE();
                    break;
                case 'F':
                    sectionData = collectSectionF();
                    break;
                default:
                    console.warn(`Unknown section ID: ${sectionId}`);
                    return;
            }
            console.log(`Saving Section ${sectionId}:`, sectionData);
            alert(`Section ${sectionId} data saved to console!`);
        }

        /* =====================================================
           FORM VIEW / EDIT
        ===================================================== */
        function openNewSurvey() {
            switchFormState("entry");
            $("#myopiaForm").reset();
            $("#formEntryTitle").innerText = "New Questionnaire";
            $("#formSubmitBtnContainer").style.display = "block";
            toggleFormInputs(false);
        }

        function viewSubmittedForm(formId) {
            switchFormState("entry");
            $("#formEntryTitle").innerText = `Viewing Entry: ${formId}`;
            toggleFormInputs(true);
            $("#formSubmitBtnContainer").style.display = "none";
        }

        function submitForm() {
            const form = $("#myopiaForm");
            if (!form.checkValidity()) {
                form.classList.add("was-validated");
                // Scroll to the first invalid field
                const firstInvalid = form.querySelector(":invalid");
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
                }
                return;
            }
            form.classList.remove("was-validated");
            renderReview(); // Populate the review overlay with current form data
            openReview();   // Show the review overlay
        }

        /* =====================================================
           FORM DATA COLLECTION
        ===================================================== */
        function collectSectionA() {
            return {
                name: document.querySelector('[name="name"]').value.trim(),

                school_name:
                    document.querySelector('[name="school_name"]').value || null,

                age: parseInt(
                    document.querySelector('[name="age"]').value,
                    10
                ),

                gender:
                    document.querySelector('[name="gender"]').value,

                height: (() => {
                    const v = document.querySelector('[name="height"]').value;
                    return v ? parseFloat(v) : null;
                })(),

                weight: (() => {
                    const v = document.querySelector('[name="weight"]').value;
                    return v ? parseFloat(v) : null;
                })(),

                parental_myopia:
                    document.querySelector('input[name="parental_myopia"]:checked')?.value || null,

                num_siblings: (() => {
                    const v = document.querySelector('[name="num_siblings"]').value;
                    return v ? parseInt(v, 10) : null;
                })(),

                birth_order:
                    document.querySelector('[name="birth_order"]').value || null,

                siblings_myopia: (() => {
                    const v = document.querySelector('[name="siblings_myopia"]').value;
                    return v ? parseInt(v, 10) : null;
                })()
            };
        }


        function radioValue(name) {
            return $(`input[name="${name}"]:checked`)?.value;
        }

        function collectSectionB() {
            return {
                outdoor_time:
                    document.querySelector('[name="outdoor_time"]').value || null,

                outdoor_duration:
                    document.querySelector('input[name="outdoor_duration"]:checked')?.value || null,

                sun_exposure:
                    document.querySelector('input[name="sun_exposure"]:checked')?.value || null,

                near_work_hours:
                    document.querySelector('input[name="near_work_hours"]:checked')?.value || null,

                screen_time:
                    document.querySelector('input[name="screen_time"]:checked')?.value || null,

                primary_device:
                    document.querySelector('input[name="primary_device"]:checked')?.value || null,

                reading_distance:
                    document.querySelector('input[name="reading_distance"]:checked')?.value || null,

                viewing_posture_ratio:
                    document.querySelector('input[name="viewing_posture_ratio"]:checked')?.value || null,

                dietary_habit:
                    document.querySelector('input[name="dietary_habit"]:checked')?.value || null,

                dietary_other:
                    document.querySelector('[name="dietary_other"]').value || null,

                sleep_duration:
                    document.querySelector('input[name="sleep_duration"]:checked')?.value || null,

                usual_bedtime:
                    document.querySelector('input[name="usual_bedtime"]:checked')?.value || null
            };
        }



        function collectSectionC() {
            return {
                school_type:
                    document.querySelector('input[name="school_type"]:checked')?.value || null,

                classroom_strength:
                    document.querySelector('input[name="classroom_strength"]:checked')?.value || null,

                seating_position:
                    document.querySelector('input[name="seating_position"]:checked')?.value || null,

                teaching_methodology:
                    document.querySelector('input[name="teaching_methodology"]:checked')?.value || null,

                lighting:
                    document.querySelector('input[name="lighting"]:checked')?.value || null,

                sunlight_source:
                    document.querySelector('input[name="sunlight_source"]:checked')?.value || null
            };
        }


        function collectSectionD() {
            return {
                diagnosed_earlier:
                    document.querySelector('input[name="diagnosed_earlier"]:checked')?.value === "true",

                age_at_diagnosis: (() => {
                    const v = document.querySelector('[name="age_at_diagnosis"]').value;
                    return v ? parseInt(v, 10) : null;
                })(),

                power_changed_last_3yrs:
                    document.querySelector('input[name="power_changed_last_3yrs"]:checked')?.value === "true",

                compliance:
                    document.querySelector('input[name="compliance"]:checked')?.value || null,

                previous_re:
                    document.querySelector('[name="previous_re"]').value || null,

                previous_le:
                    document.querySelector('[name="previous_le"]').value || null,

                current_re:
                    document.querySelector('[name="current_re"]').value || null,

                current_le:
                    document.querySelector('[name="current_le"]').value || null
            };
        }


        function collectSectionE() {
            // collect checkbox values
            const sources = Array.from(
                document.querySelectorAll('input[name="source_of_awareness"]:checked')
            ).map(el => el.value);

            // include "other" text if present
            const other = document.querySelector('[name="source_other"]').value.trim();
            if (other) {
                sources.push(other);
            }

            return {
                aware_eye_strain:
                    document.querySelector('input[name="aware_eye_strain"]:checked')?.value === "true",

                access_to_vision_care:
                    document.querySelector('input[name="access_to_vision_care"]:checked')?.value === "true",

                follows_preventive_measures:
                    document.querySelector('input[name="follows_preventive_measures"]:checked')?.value || null,

                source_of_awareness:
                    sources.length ? sources.join(", ") : null
            };
        }


        function collectSectionF() {
            return {
                uncorrectedvisual_acuity_right_eye:
                    document.querySelector('[name="uncorrectedvisual_acuity_right_eye"]').value || "",

                uncorrectedvisual_acuity_left_eye:
                    document.querySelector('[name="uncorrectedvisual_acuity_left_eye"]').value || "",

                bestcorrectedvisual_acuity_right_eye:
                    document.querySelector('[name="bestcorrectedvisual_acuity_right_eye"]').value || "",

                bestcorrectedvisual_acuity_left_eye:
                    document.querySelector('[name="bestcorrectedvisual_acuity_left_eye"]').value || "",

                cycloplegic_auto_refraction_right_eye:
                    document.querySelector('[name="cycloplegic_auto_refraction_right_eye"]').value || "",

                cycloplegic_auto_refraction_left_eye:
                    document.querySelector('[name="cycloplegic_auto_refraction_left_eye"]').value || "",

                spherical_power_right_eye:
                    document.querySelector('[name="spherical_power_right_eye"]').value || "",

                spherical_power_left_eye:
                    document.querySelector('[name="spherical_power_left_eye"]').value || "",

                axial_length_right_eye:
                    document.querySelector('[name="axial_length_right_eye"]').value || "",

                axial_length_left_eye:
                    document.querySelector('[name="axial_length_left_eye"]').value || "",

                corneal_curvature_right_eye:
                    document.querySelector('[name="corneal_curvature_right_eye"]').value || "",

                corneal_curvature_left_eye:
                    document.querySelector('[name="corneal_curvature_left_eye"]').value || "",

                central_corneal_thickness_right_eye:
                    document.querySelector('[name="central_corneal_thickness_right_eye"]').value || "",

                central_corneal_thickness_left_eye:
                    document.querySelector('[name="central_corneal_thickness_left_eye"]').value || "",

                anterior_segment_finding_right_eye:
                    document.querySelector('[name="anterior_segment_finding_right_eye"]').value || "",

                anterior_segment_finding_left_eye:
                    document.querySelector('[name="anterior_segment_finding_left_eye"]').value || "",

                amblyopia_or_strabismus:
                    document.querySelector('[name="amblyopia_or_strabismus"]:checked')?.value === "true",


                fundus_examination_finding_right_eye:
                    document.querySelector('[name="fundus_examination_finding_right_eye"]').value || "",

                fundus_examination_finding_left_eye:
                    document.querySelector('[name="fundus_examination_finding_left_eye"]').value || ""
            };
        }

        function collectFormPayload() {
            const sectionA = collectSectionA();

            return {
                visit_date: new Date().toISOString().split("T")[0],

                name: sectionA.name,
                age: sectionA.age,
                gender: sectionA.gender,
                school_name: sectionA.school_name,

                lifestyle: collectSectionB(),
                environment: collectSectionC(),
                history: collectSectionD(),
                awareness: collectSectionE(),
                ocular: collectSectionF()
            };
        }



        /* =====================================================
           FORM SUBMISSION
        ===================================================== */
        /* user_dash.html - JavaScript */

        async function finalSubmit() {
            closeReview(); // Close the review overlay
            const payload = collectFormPayload();

            try {
                const res = await fetch("/api/forms/submit/", { // Ensure this matches your main urls.py prefix
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + ACCESS_TOKEN
                    },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (res.ok) {
                    // Update Success State UI
                    document.getElementById("successFormId").innerText = `#${result.student_id}`;
                    switchFormState('success');

                    // Refresh the list and dashboard in background
                    loadStudents();
                    loadDashboardMetrics();
                } else {
                    alert("Submission failed: " + (result.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Submission Error:", err);
                alert("Network error occurred.");
            }
        }


        /* =====================================================
           REVIEW OVERLAY
        ===================================================== */
        function renderReview() {
            const container = $("#reviewContent");
            const sections = $$("#forms .section-card");

            if (!sections.length) {
                container.innerHTML = "<div class='text-muted'>No sections found.</div>";
                return;
            }

            container.innerHTML = "";
            sections.forEach(sec => {
                const clone = sec.cloneNode(true);
                clone.querySelectorAll("input, select, textarea, button")
                    .forEach(el => el.disabled = true);
                container.appendChild(clone);
            });
        }

        function openReview() {
            $("#popupInline").classList.add("show");
        }
        function closeReview() {
            $("#popupInline").classList.remove("show");
        }
        function editForm() {
            closeReview();
        }

        /* =====================================================
           VALIDATION
        ===================================================== */
        function validateRadio(name, label) {
            if (![...$$(`input[name="${name}"]`)].some(r => r.checked)) {
                alert(`⚠ ${label} is mandatory`);
                return false;
            }
            return true;
        }

        function validateMyopiaForm() {
            let valid = true;

            $$("input[required], select[required]").forEach(input => {
                if (!input.value.trim()) valid = false;
            });

            [
                ["parental_myopia", "Parental Myopia"],
                ["outdoor_duration", "Outdoor Duration"],
                ["screen_time", "Screen Time"]
            ].forEach(([n, l]) => valid &= validateRadio(n, l));

            return !!valid;
        }

        /* =====================================================
           FORM SUBMIT HANDLER
        ===================================================== */
        // document.addEventListener("DOMContentLoaded", () => {
        //         const searchInput = document.getElementById("followupSearch");
        //         if (searchInput) {
        //             searchInput.addEventListener("keyup", () =>
        //                 onFollowUpSearch(searchInput)
        //             );
        //         }

        //         loadFollowUps();
        //         loadRecentActivityMock();
        //         loadPendingFollowupsMock();
        //         loadWeeklyInsightMock();
        //         loadFollowupMetricsMock();
        //         loadMySubmittedForms();

        //     });

        /* =====================================================
           LOGOUT
        ===================================================== */
        function submitLogout() {
            if (confirm("Are you sure you want to logout?")) {
                $("#logoutForm").submit();
            }
        }


        /* =====================================================
                    FOLLOW-UPS MODULE
                    (Admin + User safe, no behavior change)
        ===================================================== */

        /* -----------------------------
           State
        ----------------------------- */
        const FollowUpsState = {
            page: 1,
            pageSize: 50,
            search: "",
            isLoading: false,
        };

        /* -----------------------------
           Helpers
        ----------------------------- */
        function todayISO() {
            return new Date().toISOString().split("T")[0];
        }

        function isOverdue(nextVisitDate) {
            return nextVisitDate < todayISO();
        }

        function buildQuery(params) {
            return new URLSearchParams(params).toString();
        }

        function renderStudents(students) {
            const tbody = document.querySelector("#formsTable tbody");
            if (!students || students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4">No records found.</td></tr>`;
                return;
            }

            tbody.innerHTML = students.map(s => `
        <tr>
            <td class="ps-4 fw-bold text-primary">#${s.student_id}</td>
            <td>${s.baseline_date || 'Not set'}</td>
            <td>${s.name}</td>
            <td>
                <span class="badge bg-success bg-opacity-10 text-success">
                    ${s.baseline_date ? 'Completed' : 'Pending'}
                </span>
            </td>
            <td class="text-end pe-4">
                <button class="btn btn-sm btn-light border" onclick="viewSubmittedForm('${s.student_id}')">
                    <i class="bi bi-eye"></i> View
                </button>
            </td>
        </tr>
    `).join("");
        }

        async function openStudentTimeline(studentId) {
            const res = await fetch(`/api/user/student/${studentId}/visits/`, {
                headers: {
                    "Authorization": "Bearer " + ACCESS_TOKEN
                }
            });

            if (!res.ok) {
                alert("Failed to load student visits");
                return;
            }

            const visits = await res.json();
            renderStudentTimeline(studentId, visits);
        }

        function renderStudentTimeline(studentId, visits) {
            const tbody = document.getElementById("followupsTableBody");
            tbody.innerHTML = "";

            document.getElementById("timelineStudentId").innerText = studentId;

            visits.forEach(v => {
                tbody.innerHTML += `
      <tr>
        <td>${v.visit_date}</td>
        <td>${v.visit_type}</td>
        <td>
          ${v.visit_type === "FOLLOW_UP"
                        ? `<button class="btn btn-sm btn-outline-success"
                onclick="openFollowupModal('${studentId}')">
                New Follow-up
              </button>`
                        : "-"
                    }
        </td>
      </tr>
    `;
            });

            showSection("followups");
        }




        async function loadStudents() {
            const res = await fetch("/api/user/students/", {
                headers: {
                    "Authorization": "Bearer " + ACCESS_TOKEN
                }
            });

            if (!res.ok) {
                console.error("Failed to load students");
                return;
            }

            const students = await res.json();
            renderStudents(students);
        }

        async function viewTimeline(studentId) {
            const res = await fetch(`/api/user/student/${studentId}/visits/`);
            const visits = await res.json();

            const container = document.getElementById("timelineBody");
            container.innerHTML = "";

            visits.forEach(v => {
                const row = document.createElement("div");
                row.innerHTML = `
            <div>
                <strong>${v.visit_type}</strong> – ${v.visit_date}
            </div>
        `;
                container.appendChild(row);
            });

            document.getElementById("timelineModal").style.display = "block";
        }
        /* -----------------------------
           Rendering
        ----------------------------- */
        function renderFollowUps(rows) {
            const tbody = document.getElementById("followupsTableBody");
            tbody.innerHTML = "";

            if (!rows.length) {
                tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No follow-ups found
                </td>
            </tr>
        `;
                return;
            }

            rows.forEach(f => {
                const overdue = isOverdue(f.next_visit);
                const badgeClass = overdue ? "bg-danger" : "bg-warning text-dark";
                const badgeText = overdue ? "Overdue" : "Upcoming";

                tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${f.student_id}</td>
                <td>${f.name}</td>
                <td>${f.school || "-"}</td>
                <td>${f.last_visit}</td>
                <td>${f.next_visit}</td>
                <td>
                    <span class="badge ${badgeClass}">
                        ${badgeText}
                    </span>
                </td>
            </tr>
        `);
            });
        }

        /* -----------------------------
           Load Pipeline
        ----------------------------- */

        /* =====================
           FOLLOWUP FORM: REVIEW & SUBMIT
        ===================== */

        function reviewFollowup() {
            const form = document.getElementById('followupForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            let reviewHtml = '<dl class="row">';
            for (const [key, value] of Object.entries(data)) {
                if (value) {
                    const labelEl = form.querySelector(`[name="${key}"]`);
                    let labelText = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    if (labelEl) {
                        const closestLabel = labelEl.closest('div')?.querySelector('label, strong, span');
                        if (closestLabel) labelText = closestLabel.innerText;
                    }
                    reviewHtml += `<dt class="col-sm-5 text-capitalize">${labelText}</dt><dd class="col-sm-7">${value}</dd>`;
                }
            }
            reviewHtml += '</dl>';

            document.getElementById('followupReviewContent').innerHTML = reviewHtml;
            document.getElementById('followupReviewOverlay').classList.add('show');
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('followupModal'));
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        function closeFollowupReview() {
            document.getElementById('followupReviewOverlay').classList.remove('show');
            const modalEl = document.getElementById('followupModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.show();
        }

        function editFollowup() {
            closeFollowupReview();
        }

        async function submitFollowup() {
            const form = document.getElementById('followupForm');
            const formData = new FormData(form);

            const studentId = formData.get('fuStudentId');
            if (!studentId) {
                alert("Student ID is missing.");
                return;
            }

            formData.delete('fuStudentId');
            const ocularData = Object.fromEntries(formData.entries());

            const payload = {
                student: studentId,
                visit_date: ocularData.fuVisitDate,
                next_visit_date: ocularData.fuNextVisit,
                ocular_examination: ocularData
            };

            delete payload.ocular_examination.fuVisitDate;
            delete payload.ocular_examination.fuNextVisit;

            // Close any open modals/overlays
            if (document.getElementById('followupReviewOverlay').classList.contains('show')) {
                document.getElementById('followupReviewOverlay').classList.remove('show');
            }
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('followupModal'));
            if (modalInstance) {
                modalInstance.hide();
            }

            try {
                const res = await fetch("/api/followups/create/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + ACCESS_TOKEN },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (res.ok) {
                    alert("Follow-up saved successfully!");
                    // Here you might want to refresh the follow-up list
                    // loadFollowUps(); 
                } else {
                    alert("Submission failed: " + (result.error || result.detail || JSON.stringify(result)));
                }
            } catch (err) {
                console.error("Submission Error:", err);
                alert("A network error occurred.");
            }
        }



        /* -----------------------------
           Search
        ----------------------------- */
        function onFollowUpSearch(inputEl) {
            FollowUpsState.search = inputEl.value.trim();
            FollowUpsState.page = 1;
            // loadFollowUps();
        }

        /* -----------------------------
           Pagination (Ready, even if backend not paginated yet)
        ----------------------------- */
        function nextFollowUpsPage() {
            FollowUpsState.page++;
            // loadFollowUps();
        }

        function prevFollowUpsPage() {
            if (FollowUpsState.page > 1) {
                FollowUpsState.page--;
                // loadFollowUps();
            }
        }

        /* -----------------------------
           Lifecycle
        ----------------------------- */



        /* =====================
           MOCK : RECENT ACTIVITY
        ===================== */
        //     function loadRecentActivityMock() {
        //         const mockData = [
        //             { id: 1, student: "Rahul Kumar", date: "Today", status: "Submitted" },
        //             { id: 2, student: "Priya Singh", date: "Yesterday", status: "Submitted" },
        //             { id: 3, student: "Amit Patel", date: "2 days ago", status: "Submitted" },
        //             { id: 4, student: "Sara Khan", date: "3 days ago", status: "Submitted" },
        //             { id: 5, student: "Rohan Mehta", date: "4 days ago", status: "Submitted" }
        //         ];

        //         const tbody = document.getElementById("recentActivityBody");

        //         tbody.innerHTML = mockData.map(row => `
        //     <tr>
        //         <td>${row.student}</td>
        //         <td>${row.date}</td>
        //         <td>
        //             <span class="badge bg-success">
        //                 ${row.status}
        //             </span>
        //         </td>
        //         <td class="text-end">
        //             <button class="btn btn-sm btn-outline-primary"
        //                     onclick="alert('View form ID: ${row.id}')">
        //                 View
        //             </button>
        //         </td>
        //     </tr>
        // `).join("");
        //     }

        /* =====================
       MOCK : PENDING FOLLOW-UPS
    ===================== */
        //     function loadPendingFollowupsMock() {
        //         const mockFollowups = [
        //             { student: "Rahul Kumar", due: "Tomorrow", overdue: false },
        //             { student: "Sara Khan", due: "Today", overdue: true },
        //             { student: "Amit Patel", due: "In 3 days", overdue: false }
        //         ];

        //         const list = document.getElementById("pendingFollowupsList");

        //         list.innerHTML = mockFollowups.map(item => `
        //     <li class="list-group-item d-flex justify-content-between align-items-center">
        //         <div>
        //             <div class="fw-semibold">${item.student}</div>
        //             <small class="text-muted">
        //                 Due ${item.due}
        //             </small>
        //         </div>

        //         <span class="badge ${item.overdue ? "bg-danger" : "bg-warning text-dark"
        //             }">
        //             ${item.overdue ? "Overdue" : "Upcoming"}
        //         </span>
        //     </li>
        // `).join("");
        //     }
        /* =====================
           MOCK : WEEKLY INSIGHT
        ===================== */
        // function loadWeeklyInsightMock() {
        //     // mock numbers
        //     const thisWeek = 12;
        //     const lastWeek = 9;

        //     document.getElementById("thisWeekCount").innerText = thisWeek;
        //     document.getElementById("lastWeekCount").innerText = lastWeek;

        //     const diff = thisWeek - lastWeek;
        //     const icon = document.getElementById("weekTrendIcon");
        //     const text = document.getElementById("weekTrendText");

        //     if (diff > 0) {
        //         icon.className = "bi bi-arrow-up-circle-fill text-success fs-2";
        //         text.innerText = `+${diff} from last week`;
        //     } else if (diff < 0) {
        //         icon.className = "bi bi-arrow-down-circle-fill text-danger fs-2";
        //         text.innerText = `${diff} from last week`;
        //     } else {
        //         icon.className = "bi bi-dash-circle-fill text-secondary fs-2";
        //         text.innerText = "No change from last week";
        //     }
        // }

        /* =====================
       DASHBOARD METRICS (FIXED)
    ===================== */
        async function loadDashboardMetrics() {
            try {
                const res = await fetch("/api/user/overview/", {
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + ACCESS_TOKEN,
                        "Content-Type": "application/json"
                    }
                });

                if (!res.ok) throw new Error("Unauthorized or Server Error");

                const data = await res.json();

                // Map API data to the DOM IDs found in Section: DASHBOARD METRICS
                //
                document.getElementById("totalSubmissions").innerText = data.total_visits;
                document.getElementById("todayEntries").innerText = data.today_entries;
                document.getElementById("totalFollowups").innerText = data.followup_count;

                // Note: These IDs exist in your HTML but were commented out or placeholder
                const pendingEl = document.getElementById("pendingEntries");
                if (pendingEl) pendingEl.innerText = data.pending_count || "0";

            } catch (err) {
                console.error("Dashboard Load Error:", err);
                // Fallback UI state
                document.getElementById("totalSubmissions").innerText = "--";
            }
        }

        // // Ensure metrics load immediately when the page finishes loading
        // document.addEventListener("DOMContentLoaded", () => {
        //     if (ACCESS_TOKEN) {
        //         loadDashboardMetrics();
        //     }
        // });


        /* =====================
       NEW FOLLOW-UP ACTION
    ===================== */
        function openNewFollowup() {
            const form = document.getElementById("followupForm");
            if (form) form.reset();

            const studentIdInput = document.getElementById("fuStudentId");
            if (studentIdInput) {
                studentIdInput.value = '';
                studentIdInput.readOnly = false;
            }

            const modalTitle = document.getElementById("followupModalTitle");
            if (modalTitle) modalTitle.innerText = "New Follow-Up Entry";

            const modal = new bootstrap.Modal(
                document.getElementById("followupModal")
            );
            modal.show();
        }

        function populateAndShow(studentId, studentName) {
            const form = document.getElementById("followupForm");
            if (form) form.reset();

            const studentIdInput = document.getElementById("fuStudentId");
            if (studentIdInput) {
                studentIdInput.value = studentId;
                studentIdInput.readOnly = true;
            }

            const modalTitle = document.getElementById("followupModalTitle");
            if (modalTitle) modalTitle.innerText = `New Follow-Up for ${studentName} (${studentId})`;

            const modal = new bootstrap.Modal(
                document.getElementById("followupModal")
            );
            modal.show();
        }


        document.addEventListener("DOMContentLoaded", () => {
            if (!ACCESS_TOKEN) {
                window.location.href = "login.html";
                return;
            }

            loadDashboardMetrics();
            loadStudents();

            const submitBtn = document.getElementById('followupSubmitBtn');
            if (submitBtn) submitBtn.addEventListener('click', submitFollowup);

            const finalSubmitBtn = document.getElementById('followupFinalSubmitBtn');
            if (finalSubmitBtn) finalSubmitBtn.addEventListener('click', submitFollowup);
        });






    </script>


</body>

</html>
new_string:
<!-- Filter and Export -->
<div class="d-flex gap-2">
    <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-funnel"></i>&nbsp; Filter
        </button>
        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:320px;">
            <div class="row g-2">
                <div class="col-md-6">
                    <label for="dateFromFilter" class="form-label small fw-bold">Date From</label>
                    <input type="date" id="dateFromFilter" class="form-control form-control-sm">
                </div>
                <div class="col-md-6">
                    <label for="dateToFilter" class="form-label small fw-bold">Date To</label>
                    <input type="date" id="dateToFilter" class="form-control form-control-sm">
                </div>
            </div>
            <div class="mb-2 mt-2">
                <label for="dateFilter" class="form-label small fw-bold">Single Date</label>
                <input type="date" id="dateFilter" class="form-control form-control-sm">
            </div>
            <div class="mb-2">
                <label for="schoolFilter" class="form-label small fw-bold">School Name</label>
                <input type="text" id="schoolFilter" class="form-control form-control-sm">
            </div>
            <div class="mb-2">
                <label for="genderFilter" class="form-label small fw-bold">Gender</label>
                <select id="genderFilter" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="mb-2">
                <label for="ageFilter" class="form-label small fw-bold">Age</label>
                <input type="number" id="ageFilter" class="form-control form-control-sm">
            </div>
            <div class="d-grid gap-2 pt-2 border-top">
                <button class="btn btn-sm btn-primary" type="button" onclick="applyPatientFilters()">
                    Apply Filters
                </button>
                <button class="btn btn-sm btn-light" type="button" onclick="clearPatientFilters()">
                    Clear Filters
                </button>
            </div>
        </div>
    </div>
    <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-download"></i>&nbsp; Export
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="exportTable('excel')"><i
                        class="bi bi-file-earmark-excel-fill text-success"></i> Export as Excel</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportTable('csv')"><i
                        class="bi bi-file-earmark-spreadsheet-fill text-primary"></i> Export as CSV</a></li>
        </ul>
    </div>
</div>
old_string:
<!-- Filter -->
<div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
        <i class="bi bi-funnel"></i>&nbsp; Filter
    </button>
    <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:320px;">
        <div class="row g-2">
            <div class="col-md-6">
                <label for="dateFromFilter" class="form-label small fw-bold">Date From</label>
                <input type="date" id="dateFromFilter" class="form-control form-control-sm">
            </div>
            <div class="col-md-6">
                <label for="dateToFilter" class="form-label small fw-bold">Date To</label>
                <input type="date" id="dateToFilter" class="form-control form-control-sm">
            </div>
        </div>
        <div class="mb-2 mt-2">
            <label for="dateFilter" class="form-label small fw-bold">Single Date</label>
            <input type="date" id="dateFilter" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
            <label for="schoolFilter" class="form-label small fw-bold">School Name</label>
            <input type="text" id="schoolFilter" class="form-control form-control-sm">
        </div>
        <div class="mb-2">
            <label for="genderFilter" class="form-label small fw-bold">Gender</label>
            <select id="genderFilter" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>
        <div class="mb-2">
            <label for="ageFilter" class="form-label small fw-bold">Age</label>
            <input type="number" id="ageFilter" class="form-control form-control-sm">
        </div>
        <div class="d-grid gap-2 pt-2 border-top">
            <button class="btn btn-sm btn-primary" type="button" onclick="applyPatientFilters()">
                Apply Filters
            </button>
            <button class="btn btn-sm btn-light" type="button" onclick="clearPatientFilters()">
                Clear Filters
            </button>
        </div>
    </div>
</div>